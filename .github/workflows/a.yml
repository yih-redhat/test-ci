name: Check Compose IDs
on:
  issue_comment:
    types: [created]

env:
  COMPOSE_URL_44: https://kojipkgs.fedoraproject.org/compose/iot/latest-Fedora-IoT-44
  COMPOSE_URL_43: https://kojipkgs.fedoraproject.org/compose/iot/latest-Fedora-IoT-43

jobs:
  check-compose-43:
    runs-on: ubuntu-latest
    outputs:
      new_compose: ${{ steps.check-compose.outputs.new_compose}}
      compose-id: ${{ steps.get-compose-id.outputs.compose-id }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get compose ID for 43 IoT
      id: get-compose-id
      run: |
        compose_id=$(curl -s ${COMPOSE_URL_43}/COMPOSE_ID)
        echo "compose-id=$compose_id" >> $GITHUB_OUTPUT
        echo "COMPOSE_ID=$compose_id" >> $GITHUB_ENV

    - name: Check if compose ID exists in file
      id: check-compose
      run: |
        if grep -q "$COMPOSE_ID" compose/compose.f43-iot; then
          echo "Compose ID exists in file"
          echo "new_compose=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        echo "new_compose=true" >> $GITHUB_OUTPUT

  create-pr-43:
    runs-on: ubuntu-latest
    needs: check-compose-43
    if: needs.check-compose-43.outputs.new_compose == 'true'
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Update compose_id_43 file
      run: |
        echo "${{ needs.check-compose-43.outputs.compose-id }}" >> compose/compose.f43-iot

    - name: Create Pull Request
      id: create-pr
      uses: peter-evans/create-pull-request@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        title: "${{ needs.check-compose-43.outputs.compose-id }}"
        commit-message: "Add compose ID ${{ needs.check-compose-43.outputs.compose-id }} to compose_id_43"
        committer: fedora-ci-bot <yih@redhat.com>
        author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
        branch: cpr
        branch-suffix: random
        delete-branch: true
        body: "${{ needs.check-compose-43.outputs.compose-id }}"
        labels: auto-merge

    - name: Merge Pull Request
      if: steps.create-pr.outputs.pull-request-number != ''
      run: |
        gh pr merge --auto --merge "${{ steps.create-pr.outputs.pull-request-number }}"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  run-test:
    runs-on: ubuntu-latest
    needs: [check-compose-43, create-pr-43]
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run the tests
      uses: sclorg/testing-farm-as-github-action@v3.1.2
      with:
        compose: Fedora-43
        arch: x86_64
        api_key: ${{ secrets.TF_API_KEY }}
        tmt_context: "arch=x86_64;distro=fedora-43"
        tmt_plan_regex: iot-x86
        tf_scope: private
        variables: "COMPOSE_ID=${{ needs.check-compose-43.outputs.compose-id }}"

    - name: Send test results to Slack via webhook
      if: always()
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{
          "text": "Testing Farm Results for Fedora 43 IoT x86",
          "blocks": [
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*Testing Farm Results for Fedora 43 IoT x86*"
              }
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*Status:* ${{ job.status }}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Compose ID:* ${{ needs.check-compose-43.outputs.compose_id }}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Triggered by:* ${{ github.actor }}"
                }
              ]
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*Workflow Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
              }
            }
          ]
        }' ${{ secrets.SLACK_WEBHOOK_URL_FEDORA_IOT_CI }}
