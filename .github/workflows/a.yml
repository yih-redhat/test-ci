name: Trigger Fedora-IoT test
on:
  issue_comment:
    types: [created]

env:
  COMPOSE_URL_44: https://kojipkgs.fedoraproject.org/compose/iot/latest-Fedora-IoT-44
  COMPOSE_URL_43: https://kojipkgs.fedoraproject.org/compose/iot/latest-Fedora-IoT-43
  COMPOSE_URL_42: https://kojipkgs.fedoraproject.org/compose/iot/latest-Fedora-IoT-42

jobs:
  check-compose-42:
    runs-on: ubuntu-latest
    outputs:
      need-pr: ${{ steps.check-compose.outputs.need-pr }}
      compose-id: ${{ steps.get-compose-id.outputs.compose-id }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get compose ID for 42 IoT
      id: get-compose-id
      run: |
        compose_id=$(curl -s ${COMPOSE_URL_42}/COMPOSE_ID)
        echo "compose-id=$compose_id" >> $GITHUB_OUTPUT
        echo "COMPOSE_ID=$compose_id" >> $GITHUB_ENV

    - name: Check if compose ID exists in file
      id: check-compose
      run: |
        if grep -q "$COMPOSE_ID" compose/compose.f42-iot; then
          echo "Compose ID exists in file"
          echo "need-pr=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Check if PR already exists for this compose ID
        response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/pulls?state=open")
        if echo "$response" | grep -q "$COMPOSE_ID"; then
          echo "Open PR exists for this compose ID"
          echo "need-pr=false" >> $GITHUB_OUTPUT
        else
          echo "need-pr=true" >> $GITHUB_OUTPUT
        fi

  create-pr-42:
    runs-on: ubuntu-latest
    needs: check-compose-42
    if: needs.check-compose-42.outputs.need-pr == 'true'
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Update compose_id_42 file
      run: |
        echo "${{ needs.check-compose-42.outputs.compose-id }}" >> compose/compose.f42-iot

    - name: Create Pull Request for IoT 42
      id: create-pr
      uses: peter-evans/create-pull-request@v4
      with:
        title: "Update compose_id_42 with ${{ needs.check-compose-42.outputs.compose-id }}"
        branch: update-compose-42-${{ needs.check-compose-42.outputs.compose-id }}
        base: main
        body: "${{ needs.check-compose-42.outputs.compose-id }}"
        commit-message: "Add compose ID ${{ needs.check-compose-42.outputs.compose-id }} to compose_id_42"
        labels: |
          automated-pr
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Add test comment to PR
      if: steps.create-pr.outputs.pull-request-number
      uses: peter-evans/create-or-update-comment@v2
      with:
        issue-number: ${{ steps.create-pr.outputs.pull-request-number }}
        body: "/test-f42-iot"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
